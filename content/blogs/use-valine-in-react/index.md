---
title: React ä¸‹ Valine çš„å°è£…ä¸ä½¿ç”¨
date: '2022-05-15T11:02:38.254Z'
description: 'å‘Šåˆ«ç¬¬ä¸‰æ–¹åº“ï¼Œè‡ªå·±å°è£…ï¼Œç›´æ¥ä½¿ç”¨'
tags: ['æŠ€æœ¯']
img: 'img.png'
---

## å†™åœ¨å‰é¢

æˆ‘çš„åšå®¢ä¸€ç›´ä½¿ç”¨ [Valine](https://valine.js.org/) æ¥ä½œä¸ºå¤–æŒ‚çš„è¯„è®ºç³»ç»Ÿï¼Œå› æ­¤ä½¿ç”¨ä¸€ä¸ªç¬¬ä¸‰æ–¹ç»„ä»¶æ˜¯ååˆ†çœæ—¶çœåŠ›çš„ï¼Œä½†æ˜¯æœ€è¿‘å› ä¸ºä¸€äº›åŸå› æˆ‘å†³å®šè‡ªå·±å°è£…ä¸€ä¸ªç»„ä»¶æ¥ä½¿ç”¨ï¼Œç»“æœå·¥ä½œè¦æ¯”æƒ³è±¡ä¸­çš„ç®€å•ã€‚

## ä¸ºä»€ä¹ˆè¦è‡ªå·±å°è£…ï¼Ÿ

ä¸»è¦åŸå› æ˜¯æˆ‘ä½¿ç”¨çš„ gatsby-plugin-valine å·²ç»ä¸¤å¹´æœªå†æ›´æ–°ï¼Œå…¶è¿‡æ—¶çš„ Valine ä¾èµ–ä¼šå¯¼è‡´é¡¹ç›®ä¸­å­˜åœ¨ä¸å®‰å…¨çš„ä»£ç ï¼Œæœ€è¿‘ Valine å°±è¿ç»­ä¿®è¡¥äº†å‡ ä¸ª XSS æ¼æ´ï¼ŒåŠæ—¶æ›´æ–°åˆ°æœ€æ–°çš„ä¾èµ–æ˜¯å¾ˆé‡è¦çš„ã€‚

å¦å¤–ï¼Œè‹¥æ˜¯ä½ æ‰€åœ¨çš„å¼€å‘ç¯å¢ƒæ²¡æœ‰æˆ–ä¸èƒ½æä¾›è¿™ç±»ç¬¬ä¸‰æ–¹ç»„ä»¶æ—¶ï¼Œå”¯ä¸€çš„åŠæ³•å°±æ˜¯è‡ªå·±å°è£…ä¸€ä¸ªã€‚

## æ€ä¹ˆå°è£…ï¼Ÿ

å°è£…çš„ç»„ä»¶ä¸»è¦è´Ÿè´£è¿™äº›å·¥ä½œï¼š

1. åˆ›å»º `ref` ç»‘å®šç»™ `div` å…ƒç´ 
2. åˆå¹¶é»˜è®¤é…ç½®å’Œç»„ä»¶ `props` ä¸­çš„é…ç½®
3. å°†é…ç½®è¿åŒ `ref` ä¼ é€’ç»™ Valine æ¥åˆ›å»ºå®ä¾‹
4. è‹¥é…ç½®æ”¹å˜ï¼Œåˆ™é‡æ–°åˆ›å»ºå®ä¾‹

è¿™äº›éƒ½å¯ä»¥ç”¨ React Hooks çš„ `useRef` å’Œ `useEffect` æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```jsx
import React from 'react';

// åˆ›å»ºä¸€ä¸ª config å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å¯¼å…¥ä¸€ä¸ªé…ç½®æ–‡ä»¶
const config = {
    appId: 'xxxx',
    appKey: 'xxxx',
};

// åŠ¨æ€å¯¼å…¥ Valine å¹¶åˆ›å»ºå®ä¾‹
const buildValine = async (options) => {
    const RealValine = await (await import('valine')).default;
    new RealValine(options);
};

// è¿™é‡Œåªæš´éœ²äº† path å‚æ•°ä¼ é€’ç»™ Valineï¼Œå…¶å®ƒé…ç½®å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ä»£ç 
export default function Valine({path = '', ...others}) {
    // åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œç”¨äºç»‘å®š `div` å…ƒç´ 
    const ref = React.useRef(null);

    // useEffect åªä¼šåœ¨å®¢æˆ·ç«¯åŠ è½½é¡µé¢åè¿›è¡Œï¼Œå¯¹æœåŠ¡ç«¯æ— æ•ˆ
    React.useEffect(() => {
        // å½“ ref å¯¹è±¡å­˜åœ¨ï¼Œè°ƒç”¨ buildValine
        if (ref.current) {
            buildValine({
                el: ref.current,
                path,
                ...config,
            });
        }
    }, [path, config, ref]);

    return <div ref={ref} {...others} />;
}
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼šè¿™é‡Œå°† Valine çš„åˆå§‹åŒ–é€»è¾‘æ”¾åœ¨ `React.useEffect` ä¸­ä¸”å¯¹ Valine è¿›è¡ŒåŠ¨æ€å¯¼å…¥æ˜¯å› ä¸º Valine çš„ä»£ç ä¸­ä½¿ç”¨åˆ°äº† `window` å¯¹è±¡ï¼Œåœ¨æœåŠ¡ç«¯é‡Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› æ­¤å¦‚æœä¸æ”¾åœ¨ `useEffect` ç”Ÿå‘½å‘¨æœŸä¸­å¹¶åŠ¨æ€å¯¼å…¥å°±ä¼šå¯¼è‡´ SSR é¡¹ç›®å‡ºç°æŠ¥é”™ã€‚

## å¦‚ä½•ä½¿ç”¨ï¼Ÿ

ä½¿ç”¨æ–¹æ³•åŒç¬¬ä¸‰æ–¹ä¾èµ–å·®ä¸å¤šï¼Œå°†ä¸Šé¢ä»£ç ä¿å­˜ä¸º `Valine.jsx`ï¼Œåœ¨åˆé€‚çš„åœ°æ–¹æ·»åŠ ä¸‹é¢ä¸¤è¡Œä»£ç å³å¯ä½¿ç”¨ï¼š

```jsx
import Valine from './Valine';
<Valine path="/">
```

å¦‚æ­¤å°±å¤§åŠŸå‘Šæˆäº†ï¼Œä»£ç ä¹Ÿæ˜¯æ ¹æ®æˆ‘çš„ä¸ªäººéœ€è¦ç¼–å†™ï¼Œå› æ­¤ç›¸å¯¹ç®€é™‹ï¼ˆä¸è¿‡è¿™ä¹Ÿç®—æ˜¯ä¹è¶£ä¹‹ä¸€å§ï¼‰ã€‚

## æ¥è¯•è¯•å§ï¼ˆæ›´æ–°äº 2022/11/27ï¼‰

æˆ‘å·²ç»å‘å¸ƒäº†ä¸€ä¸ªé€‚ç”¨äº Gatsby ç«™ç‚¹çš„ Valine æ’ä»¶ğŸ˜‹

[$card](https://github.com/Talaxy009/gatsby-plugin-valine-comment)
