---
title: ä½¿ç”¨ react-tweet æ¥åµŒå…¥æ¨ç‰¹æ¨æ–‡
date: '2023-05-07T22:35:12.990Z'
description: 'æœ€è¿‘å‘ç°äº†ç”± Vercel å¼€å‘çš„å¼€æºåº“ï¼šreact-tweetã€‚å¯éƒ¨ç½²ä¸º Serveless å‡½æ•°ï¼Œå¹¶ä¸ºç½‘é¡µåµŒå…¥æ¨ç‰¹æ¨æ–‡å¡ç‰‡ï¼Œè¿™çœŸæ˜¯å¤ªé…·å•¦ï¼'
tags: ['æŠ€æœ¯']
img: 'img.png'
---

import Tweet from '/src/components/Tweet';

æœ€è¿‘å‘ç°äº†ä¸€ä¸ªå¼€æºåº“ï¼šreact-tweetï¼Œç”± Vercel Labs å¼€å‘ã€‚å¯éƒ¨ç½²ä¸º Serveless å‡½æ•°ã€ä¸ºç½‘é¡µåµŒå…¥æ¨ç‰¹æ¨æ–‡å¡ç‰‡ã€æ”¯æŒå¤œé—´æ¨¡å¼ã€è¿˜ä½¿ç”¨äº† SWR å’Œ React Server Components åœ¨å†…çš„æ–°æŠ€æœ¯ï¼Œè¿™å®åœ¨æ˜¯å¤ªé…·å•¦ï¼æˆ‘æ•´æ•´æŠŠç©äº†ä¸€å¤©ï¼

[$card](https://github.com/vercel-labs/react-tweet/)

Vercel ä½¿ç”¨ Next.js æ­å»ºçš„ Demoï¼Œå¾ˆå¥½çš„å±•ç¤ºäº†å…¶æ‰€æœ‰ç‰¹æ€§ï¼Œå¯ä»¥å»ä½“éªŒä¸‹ï¼š

[$card](https://static-tweet.vercel.app/)

## ä¼ ç»Ÿæ–¹æ³•ä¸å…¶å¼Šç«¯

å°†æ¨ç‰¹æ¨æ–‡åµŒå…¥ç½‘é¡µä¸æ˜¯ä»€ä¹ˆæ–°é²œäº‹ï¼Œå¦‚ä¸‹å›¾ï¼Œåªè¦ç‚¹ä¸€ä¸‹â€œåµŒå…¥æ¨æ–‡â€å°±èƒ½æ‹¿åˆ°ä¸€ä¸²â€œç¥ç§˜ä»£ç â€ï¼ŒæŠŠä»£ç ç²˜è´´åœ¨æƒ³è¦çš„åœ°æ–¹å°±å¯ä»¥äº†ã€‚

![åµŒå…¥æ¨æ–‡ç¤ºæ„å›¾](./2023-05-08.png)

è¿™ç§æ–¹å¼è‡ªç„¶æœ‰å…¶å¼Šç«¯ï¼š

é¦–å…ˆï¼Œä»£ç æ˜¯éœ€è¦ä» platform.twitter.com åŠ è½½ JS è„šæœ¬çš„ï¼Œè™½ç„¶åœ¨æµ·å¤–è®¿é—®æ¨ç‰¹çš„æœåŠ¡å™¨éå¸¸è¿…é€Ÿï¼Œä½†åœ¨å†…åœ°å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› è¿™æ®µè„šæœ¬æ˜¯åŠ è½½ä¸å‡ºæ¥çš„ï¼Œå› æ­¤åµŒå…¥çš„æ¨æ–‡ä¼šä¸€ç›´æ˜¯é»˜è®¤ blockquote çš„æ ·å­ã€‚

å…¶æ¬¡ï¼ŒåµŒå…¥çš„å¡ç‰‡æ ·å¼ä¸€ç›´æ˜¯é»˜è®¤çš„ç™½è‰²èƒŒæ™¯ï¼Œè¿™åœ¨ç½‘é¡µåˆ‡æ¢ä¸ºå¤œé—´æ¨¡å¼æ—¶ååˆ†ä¸åè°ƒã€‚

æœ€åï¼Œæ¯åµŒå…¥ä¸€ä¸ªæ¨æ–‡éƒ½è¦ç²˜è´´ä¸å°‘çš„ä»£ç åœ¨æ–‡ç« æˆ–ç¨‹åºä¸­ï¼Œä¸å¤Ÿç®€æ´ã€‚

## å¦‚ä½•ä½¿ç”¨ react-tweet

### å‰ç«¯

åœ¨ react-tweet çš„ä»“åº“ä¸­å·²ç»æ”¾äº† Next.jsã€Vite å’Œ Create React App çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥å»çœ‹çœ‹ã€‚

åŸºæœ¬ç”¨æ³•ï¼š

```jsx
import { Tweet } from 'react-tweet'

export const IndexPage = () => <Tweet id="1628832338187636740" />
```

åªéœ€è¦ä¼ é€’ä¸€ä¸ªæ¨æ–‡ ID å³å¯ã€‚

åœ¨ SSR æ¡†æ¶ä¸‹å¯èƒ½ä¼šé‡åˆ° React çš„æ°´åˆæŠ¥é”™ï¼Œå¯ä»¥è‡ªè¡Œå°è£…ä¸€ä¸ªç»„ä»¶åšç±»ä¼¼å¤„ç†ï¼š

```jsx
import React from 'react';
import {Tweet as ReactTweet, TweetSkeleton} from 'react-tweet';

export default function Tweet({id = ''}) {
  const [mounted, setMounted] = React.useState(false);

  React.useEffect(()=>{
    setMounted(true);
  }, []);

  return mounted ? (
    <ReactTweet id={id} />
  ) : (
    <TweetSkeleton />
  );
}
```

### åœ¨ Gatsby ä¸‹ä½¿ç”¨çš„æ–¹æ³•

æˆ‘åœ¨ Gatsby ä¸­ä½¿ç”¨æ—¶å‡ºäº†é—®é¢˜ï¼Œæ§åˆ¶å°è¾“å‡ºäº†ä¸€å † CSS æ ·å¼å¯¼å…¥çš„é—®é¢˜ï¼Œå¹¸å¥½åœ¨è¿™ç¯‡ issue ä¸­å¼€å‘è€…å·²ç»ç»™å‡ºäº†è§£å†³åŠæ³•ã€‚

[$card](https://github.com/vercel-labs/react-tweet/issues/45)

éœ€è¦åœ¨ gatsby-node.js ä¸‹ä¿®æ”¹ Webpack é…ç½®ï¼š

```js
export const onCreateWebpackConfig = ({
  actions,
  getConfig,
}) => {
  const config = getConfig();

  config.module.rules.forEach((rule) => {
    rule.oneOf?.forEach((rule) => {
      rule.use?.forEach((plugin) => {
        // æˆ‘å°†åŸä»£ç ä¸­çš„"/"åˆ æ‰äº†ï¼Œå› ä¸º Windows çš„è·¯å¾„ä½¿ç”¨çš„æ˜¯"\"ï¼Œä¼šæ— æ³•åŒ¹é…
        if (
          plugin.loader.includes('css-loader') ||
          plugin.loader.includes('mini-css-extract-plugin')
        ) {
          if (plugin.options.modules?.namedExport) {
            plugin.options.modules.namedExport = false;
          }
        }
      });
    });
  });
  actions.replaceWebpackConfig(config);
};
```

ä»¥åŠè¿˜éœ€è¦åœ¨ gatsby-browser.js ä¸­æ‰‹åŠ¨å¯¼å…¥ theme.css:

```js
import 'react-tweet/theme.css';
```

åšå®Œè¿™äº›å·¥ä½œï¼Œreact-tweet æ‰ç®—èƒ½åœ¨ Gatsby ä¸­ä½¿ç”¨ï¼Œä½†ä»…é™ SWR ä¸‹ã€‚æ ¹æ®è¯¥ issue æ‰€è¯´ï¼Œåœ¨å¼€å¯äº† PARTIAL_HYDRATION å Gatsby æŠ¥é”™äº†ï¼ˆGatsby å¼€å¯è¯¥é€‰é¡¹åä¼šä½¿ç”¨ React Server Componentsï¼‰ï¼Œç”±äºæˆ‘å¹¶ä¸ä½¿ç”¨è¯¥ç‰¹æ€§å°±ä¸ç»§ç»­å¤„ç†è¿™ä¸ªé—®é¢˜äº†ï¼ˆæ¯•ç«Ÿå¼€å‘è€…éƒ½æ²¡æœ‰æ‰¾åˆ°è§£å†³åŠæ³•ï¼Œæœ€åç”šè‡³å°†æ•´ä¸ª Gatsby ç¤ºä¾‹ç»™åˆ æ‰äº†ğŸ˜•ï¼‰

### Serverless å‡½æ•°

æ ¹æ®æ–‡æ¡£æ‰€è¯´ï¼š

> è‹¥ Tweet ç»„ä»¶çš„ä½¿ç”¨ç¯å¢ƒä¸æ”¯æŒ React Server Componentsï¼Œå®ƒå°†ä½¿ç”¨ SWR ä½œä¸ºä»£æ›¿ï¼Œä¸”æ¨æ–‡æ•°æ®ä¼šå‘è·¨åŸŸå‹å¥½çš„ `https://react-tweet.vercel.app/api/tweet/:id` è·å–ã€‚

åŒæ ·å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå›  Vercel åœ¨å†…åœ°ä¹Ÿæ˜¯æ— æ³•è®¿é—®çš„ï¼Œä¸ºæ­¤å¯ä»¥é€‰æ‹©è‡ªè¡Œéƒ¨ç½²ä¸€ä¸ª Vercel Function å¹¶ä½¿ç”¨è‡ªå·±çš„åŸŸåè¿›è¡Œè®¿é—®ï¼Œå¼€å‘è€…ä¹Ÿç»™å‡ºäº†ç¤ºä¾‹ä»£ç ï¼Œä½ å¯ä»¥åœ¨ [apps/vite-app/api/tweet/](https://github.com/vercel-labs/react-tweet/blob/main/apps/vite-app/api/tweet/%5Btweet%5D.ts) æ‰¾åˆ°ã€‚

æˆ‘çš„åšå®¢æ˜¯éƒ¨ç½²åœ¨ Netlify ä¸Šçš„ï¼Œå› æ­¤å®ç°ä¸€ä¸ª Netlify Function ä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œæˆ‘çš„å®ç°å¦‚ä¸‹ï¼š

```ts
import {
  Handler,
  HandlerEvent,
  HandlerContext,
  HandlerResponse,
} from "@netlify/functions";
import { getTweet } from "react-tweet/api";

// é…ç½®è·¨åŸŸï¼Œæ–¹ä¾¿æœ¬åœ°å¼€å‘
const headers: HandlerResponse["headers"] = {
  "Access-Control-Allow-Origin": "http://localhost:8000",
};

export const handler: Handler = async (
  event: HandlerEvent,
  _context: HandlerContext
) => {
  const tweetId = event.path.split("/").pop();

  console.log({ tweetId });

  if (event.httpMethod !== "GET" || typeof tweetId !== "string") {
    return {
      headers,
      statusCode: 400,
      body: JSON.stringify({ error: "Bad Request." }),
    };
  }

  try {
    const tweet = await getTweet(tweetId);

    return {
      headers,
      statusCode: tweet ? 200 : 404,
      body: JSON.stringify({ data: tweet ?? null }),
    };
  } catch (error) {
    console.error(error);
    return {
      headers,
      statusCode: 400,
      body: JSON.stringify({ error: error.message ?? "Bad request." }),
    };
  }
};
```

æˆ‘åœ¨ yarn berry çš„ pnp æ¨¡å¼ä¸‹ä½¿ç”¨ Netlify Cli æœ‰ç‚¹é—®é¢˜ï¼Œå› æ­¤å•ç‹¬å»ºäº†ä¸€ä¸ªä»“åº“ç”¨äºæ”¾ç½® Function çš„ä»£ç ä»¥ä¾¿å•ç‹¬æ‰“åŒ…åå†éƒ¨ç½²ã€‚

[$card](https://github.com/Talaxy009/react-tweet-netlify)

æ­¤å¤–ï¼Œå› ä¸º react-tweet ç”¨åˆ°äº† Fetch API å› æ­¤éœ€è¦ä½¿ç”¨ Node.js 18 æ‰èƒ½è¿è¡Œï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²å‰è¿˜è¦å°† Netlify çš„ç¯å¢ƒå˜é‡ `AWS_LAMBDA_JS_RUNTIME` è®¾ä¸º `nodejs18.x`ã€‚

å¦‚æœæƒ³è®©è®¿é—®çš„ URL æ›´ç®€æ´ï¼Œè¿˜å¯æ·»åŠ ä¸€æ¡é…ç½®åˆ° _redirects ä¸­ï¼Œè¿™æ ·ä¸€æ¥ç›´æ¥è¯·æ±‚ `/api/tweet/:id` å°±å¯ä»¥äº†ã€‚

```txt
/api/*  /.netlify/functions/:splat  200
```

æœ€åä¿®æ”¹ä¸€ä¸‹ä¹‹å‰åŒ…è£…çš„ç»„ä»¶ï¼Œ`siteUrl` æ˜¯ç«™ç‚¹çš„é¦–é¡µåœ°å€ï¼Œä¸ºäº†æ–¹ä¾¿æœ¬åœ°è°ƒè¯•å› æ­¤æ²¡æœ‰ä½¿ç”¨ç»å¯¹è·¯å¾„ã€‚

```diff
- <ReactTweet id={id} />
+ <ReactTweet apiUrl={`${siteUrl}/api/tweet/${id}`} />
```

å¤§åŠŸå‘Šæˆï¼ğŸ‰

## åè®°

å…³äº React Server Components éƒ¨åˆ†çš„ç‰¹æ€§æ²¡èƒ½ä½“éªŒåˆ°ï¼Œæ¯”è¾ƒå¯æƒœï¼Œä½†è¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡ä½“éªŒ Serverless Functions ä¹Ÿæ˜¯è›®æœ‰è¶£çš„ã€‚

æœ€ååµŒå…¥ä¸€æ¡å¯çˆ±çš„äºŒæ¬¡å…ƒçº¸ç‰‡äººæ¨æ–‡ï¼š

<Tweet id="1653937781549461504" />
